<html>
<head>
  <style>

  .text-wrapper {
    position: relative;
    left: 25%;
    top: 20px;
    width: 50%;
    height: 40%;
    display: block;
  }

  .sixkeys {
    width: 100%;
    height: 100%;
  }

  .svg-container {
    position: relative;
    padding-top: 40px;
    width: 100%;
  }

  .svg-wrapper {
    height: 0;
    width: 60%;
    position: relative;
    padding-bottom: 20%;
    margin-left: 20%;
  }

  #svg2 {
    width: 100%;
    height: 100%;
    position: absolute;
  }

  #qwerty {
    /*position: relative;*/
    /*left:50%;*/
    transform: translateX(10%);
    /*display: inline-block;*/
    /*margin: auto;*/
  }

  </style>
</head>
<body>
<div class="text-wrapper">
  <textarea class="sixkeys" readonly="true">
  </textarea>
</div>
<div class="svg-container">
  <div class="svg-wrapper">
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.0/d3.min.js"></script>
<script src="./keymap.js"></script>
<script>
  var svg;
  window.onload=function() {
    var homeRow = ["l","k","j","f","d","s"];
    var numPad1 = ["3","2","1","7","8","9"];
    var numPad2 = ["+","6","5","=","/","*"];
    var keys = homeRow;
    var bits = 0;
    var shift = 0;
    var numShift = 0;
    var blueColor = "#97c5d5";
    // var svg;

    $(document).keydown(function(e) {
      if (keys.indexOf(e.originalEvent.key) != -1) {
        // console.log(e.originalEvent.key);
        if (bits == 7) {
          $(".sixkeys").text($(".sixkeys").text().slice(0,-1));
        } else {
          switch (e.originalEvent.key) {
            case keys[0]: //l
              bits|= 1;
              blurKeys(1);
              break;
            case keys[1]: //k
              bits|= 2;
              blurKeys(2);
              break;
            case keys[2]: //j
              bits|= 4;
              blurKeys(4);
              break;
            case keys[3]: //f
              bits|= 8;
              blurKeys(8);
              break;
            case keys[4]: //d
              bits|= 16;
              blurKeys(16);
              break;
            case keys[5]: //s
              bits|= 32;
              blurKeys(32);
              break;
          }
        }
        return false;
      }
    });

    $(document).keyup(function(e) {
      if (keys.indexOf(e.originalEvent.key) != -1 && bits > 0) {
        // console.log("bits " + bits);
        switch (bits) {
          case 7: // Backspace
            $(".sixkeys").text($(".sixkeys").text().slice(0,-1));
            break;
          case 18: // Shift & 'Caps Lock'
            shift = (shift + 1) % 3;
            switch (shift) {
              case 1:
                d3.selectAll(".shift").selectAll("path").style("fill","red");
                break;
              case 2:
                d3.selectAll(".shift").selectAll("path").style("fill",blueColor);
                d3.select(svg).select("#key-caps").selectAll("path").style("fill","red");
                break;
              default:
                d3.select(svg).select("#key-caps").selectAll("path").style("fill",blueColor);
                break;
            }
            // console.log("shift " + shift);
            break;
          case 12: // 'Number Shift'
            numShift = (numShift + 2) % 6;
            switch (numShift) {
              case 2:
                d3.select(svg).selectAll(".key:not(.control),.key:not(.numShift1)").style("opacity",0.25);
                break;
              case 4:
                d3.select(svg).selectAll(".key:not(.control),.key:not(.numShift2)").style("opacity",0.25);
                break;
            }
            break;
          default:
            if (bits in letters) {
              $(".sixkeys").append(shift > 0 ? letters[bits][1 + numShift] : letters[bits][0 + numShift]);
              if (shift == 1) {
                shift = 0;
                d3.selectAll(".shift").selectAll("path").style("fill",blueColor);
              }
            }
            break;
        }
      }
      bits = 0;
      d3.select(svg).selectAll(".home").style("opacity",1);
      d3.select(svg).selectAll(".mapped").selectAll("path").style("fill",blueColor);
      if (keys.indexOf(e.originalEvent.key) != -1) {
        switch (numShift) {
          case 0:
            d3.select(svg).selectAll(".key").style("opacity",1);
            break;
          case 2:
            d3.select(svg).selectAll(".key.numShift1,.key.control").style("opacity",1);
            break;
          case 4:
            d3.select(svg).selectAll(".key.numShift2,.key.control").style("opacity",1);
            break;
        }
        return false;
      }
    });

    // $.get("/6-Key-QWERTY/Qwerty-Second-Homerow.svg", function(data) {
      $.get("./Qwerty-Second-Homerow.svg", function(data) {
      $(".svg-wrapper").html(data);
      svg = d3.select("#svg2").node();
    },"text")
    .fail(function(xhr,txt,err) {
      console.log(xhr);
      console.log(txt);
      console.log(err);
    });

    function blurKeys(bit) {
      var selectorString;
      switch (numShift) {
        case 0:
          selectorString = ".numShift0";
          break;
        case 2:
          selectorString = ".numShift1";
          break;
        case 4:
          selectorString = ".numShift2";
          break;
      }
      // Reducing the opacity on keys that cannot be typed at the moment
      d3.select(svg).selectAll(".key:not(.control):not("+selectorString+")").style("opacity",0.25);
      var exclude = d3.select(svg).selectAll(".control,"+selectorString).nodes().filter( function(el) {
        return ((parseInt(el.id.split("-")[2]) & bit) == 0);
      });
      d3.selectAll(exclude).style("opacity",0.25);

      // Reduce the opacity of the 'home' keys that are not being pressed currently.
      d3.select(svg).selectAll(".home").style("opacity",0.5);
      var home = d3.select(svg).selectAll(".home").nodes().filter( function(el) {
        return ((parseInt(el.id.split("-")[2]) & bits) > 0);
      });
      d3.selectAll(home).style("opacity",1);

      // Modify the fill of potential keys presses so people know what to press next to type that key
      var include = d3.select(svg).selectAll(".control,"+selectorString).nodes().filter( function(el) {
        return ((parseInt(el.id.split("-")[2]) & bit) > 0);
      })

      d3.selectAll(include).selectAll("path")
      .style("fill", function() {
        var shiftBits = parseInt(this.parentNode.id.split("-")[2]) - bit;
        var shiftBits2 = shiftBits;
        var keyCombination = {};
        keyCombination[shiftBits2] = [];
        var place = 0;
        while (shiftBits > 0) {
          // console.log((shiftBits & 1) + " at position " + Math.pow(2,place));
          if ( (shiftBits & 1) == 1 ) {
            var tmp = d3.select(svg).selectAll(".home").nodes().filter( function(el){
              return (parseInt(el.id.split("-")[2]) == Math.pow(2,place))
            });
            // need to push into an array of different fill strings
            // if the array length is 1 return a string
            // if the array has two elements then create a gradient in defs if it doesn't exist and provide as fill
            // return d3.selectAll(tmp).selectAll("path").style("fill");// || this.style("fill");
            keyCombination[shiftBits2].unshift(d3.selectAll(tmp).selectAll("path").style("fill"));
          }
          shiftBits >>>= 1;
          place ++;
        }

        if (keyCombination[shiftBits2].length == 1) {
          return keyCombination[shiftBits2][0];
        } else {
          return "purple";
        }

      });

    }

  }
</script>
</body>
</html>
